{
  "version": 3,
  "sources": [
    "../src/index.js"
  ],
  "names": [],
  "mappings": "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",
  "file": "index.js",
  "sourcesContent": [
    "/*\n * Copyright [2015-2017] Fraunhofer Gesellschaft e.V., Institute for\n * Open Communication Systems (FOKUS)\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n *\n */\n\n'use strict';\nimport logger from \"logops\";\nimport lwm2mlib from \"lwm2m-node-lib\";\nimport Database from \"./Database\";\n\nlet lwm2m = {};\nlwm2m.server = lwm2mlib.server; //Enables use of all native lwm2m-lib methods\nlwm2m.serverInfo = {};\nlet config = {};\nlet database;\n\nlogger.format = logger.formatters.dev;\n\nlwm2m.setConfig = function (c) {\n    config = c;\n\n    if (config.server.logLevel) {\n        logger.setLevel(config.server.logLevel);\n    }\n};\n\nlwm2m.getConfig = function () {\n    return config;\n};\n\nlwm2m.start = function () {\n    return new Promise(function (resolve, reject) {\n        if (typeof config === 'undefined') {\n            logger.error(\"Missing configuration!\");\n            reject();\n        }\n        database = new Database(config);\n        database.connect()\n            .catch(function (error) {\n                logger.error(error);\n                reject(error);\n            })\n            .then(function () {\n                database.isInitialised()\n                    .catch(function (error) {\n                        logger.error(error);\n                        reject(error);\n                    })\n                    .then(function (initialised) {\n                        if (!initialised) {\n                            database.createHotel()\n                                .catch(function (error) {\n                                    logger.error(error);\n                                    reject(error);\n                                })\n                                .then(function (errors) {\n                                    if (errors) {\n                                        logger.error(\"Problems while initialising db: \", errors);\n                                    }\n                                    else {\n                                        logger.info(\"Database initialised with config-data!\");\n                                    }\n                                    startm2m()\n                                        .catch(reject)\n                                        .then(resolve);\n                                });\n                        }\n                        else {\n                            logger.info(\"Database already initialised. Using existing data.\");\n                            startm2m()\n                                .catch(reject)\n                                .then(resolve);\n                        }\n                    });\n            });\n    });\n};\n\nfunction startm2m() {\n    return new Promise(function (resolve, reject) {\n        lwm2m.server.start(config.server, function (error, results) {\n            if (error) {\n                logger.error(error);\n                reject(error);\n            }\n            else {\n                lwm2m.serverInfo = results;\n                setHandlers().then(resolve);\n            }\n        });\n    });\n}\n\n\nlwm2m.stop = function () {\n    return new Promise(function (resolve, reject) {\n        database.disconnect()\n            .catch(function (error) {\n                logger.error(error);\n                reject();\n            });\n\n        if (!lwm2m.serverInfo) {\n            var error = \"Can't stop m2m server. Not running\";\n            logger.error(error);\n            reject(error);\n        }\n\n        lwm2m.server.stop(lwm2m.serverInfo, function (error) {\n            if (error) {\n                reject(error);\n            }\n            else {\n                resolve();\n            }\n        });\n    });\n};\n\nfunction registrationHandler(endpoint, lifetime, version, binding, payload, callback) {\n    logger.info('\\nDevice registration:\\n----------------------------\\n');\n    logger.info('Endpoint name: %s\\nLifetime: %s\\nBinding: %s\\n Payload: %s', endpoint, lifetime, binding, payload);\n\n    database.registerDevice(endpoint, true, payload)\n        .catch(function (error) {\n            logger.error(\"Error while updating device-data\", error);\n        })\n        .then(function () {\n            observeDeviceData(endpoint, 3303, 0, 5700); //Temperature\n            observeDeviceData(endpoint, 3304, 0, 5700); //Humidity\n            callback();\n        });\n}\n\nfunction unregistrationHandler(device, callback) {\n    logger.info('\\nDevice unregistration:\\n----------------------------\\n');\n    logger.info('Device location: %s', device.name);\n\n    database.registerDevice(device.name, false)\n        .catch(function (error) {\n            logger.error(\"Error while updating device-data\", error);\n        })\n        .then(callback);\n}\n\n\nfunction observeHandler(objectType, objectId, resourceId, deviceId, value) {\n    lwm2m.server.getRegistry().get(deviceId, function (error, device) {\n        database.storeValue(device.name, ('/' + objectType + '/' + objectId + '/' + resourceId), value)\n            .catch(function (error) {\n                logger.error(\"Error while storing observe-data in db! Device: %s\", device.name, error);\n            })\n            .then(function () {\n                logger.debug(\"Stored observe-data for device '%s' in db!\", device.name);\n            });\n    });\n    logger.debug(\"Observe-handler device [\" + deviceId + \", objectType \" + objectType + \", objectId \" + objectId + \", resourceId: \" + resourceId + \"] => \" + value);\n}\n\nfunction observeDeviceData(deviceName, objectType, objectId, resourceId) {\n    lwm2m.server.getRegistry().getByName(deviceName, function (error, device) {\n        if (error) {\n            logger.error(error);\n        }\n        else {\n            lwm2m.server.observe(device.id, objectType, objectId, resourceId, observeHandler, function (error, value) {\n                if (error) {\n                    logger.error(\"Error while starting observe!\", error)\n                }\n                else {\n                    logger.debug(\"Started observe for '%s'. First value: \", deviceName, value);\n                    if (value === '') { //No data => Device does not set data\n                        logger.debug(\"Device '\" + deviceName + \"' does not set /\" + objectType + \"/\" + objectId + \"/\" + resourceId + \"! Canceling observe.\");\n                        lwm2m.server.cancelObserver(device.id, objectType, objectId, resourceId, function () {\n                            logger.debug(\"Observe for '%s' canceled!\", device.name);\n                        });\n                    }\n                    else {\n                        database.storeValue(deviceName, ('/' + objectType + '/' + objectId + '/' + resourceId), value)\n                            .catch(function (error) {\n                                logger.error(\"Error while storing initial read-data!\", error);\n                            })\n                            .then(function () {\n                                logger.debug(\"Stored initial read-data from observe.\");\n                            });\n                    }\n                }\n            });\n        }\n    });\n\n}\n\nfunction setHandlers() {\n    return new Promise(function (resolve) {\n        lwm2m.server.setHandler(lwm2m.serverInfo, 'registration', registrationHandler);\n        lwm2m.server.setHandler(lwm2m.serverInfo, 'unregistration', unregistrationHandler);\n        logger.debug(\"Set registration handlers.\");\n        resolve();\n    });\n}\n\nexport default lwm2m;"
  ]
}