{
  "version": 3,
  "sources": [
    "../src/index.js"
  ],
  "names": [],
  "mappings": "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",
  "file": "index.js",
  "sourcesContent": [
    "/*\n * Copyright [2015-2017] Fraunhofer Gesellschaft e.V., Institute for\n * Open Communication Systems (FOKUS)\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n *\n */\n'use strict';\n\n\nimport lwm2mlib from \"lwm2m-node-lib\";\nimport logger from \"logops\";\nimport cmd from \"command-node\";\nimport config from \"./../config\";\nimport TempSensor from \"./TempSensor\";\nimport Hue from \"./Hue\";\n\nlogger.format = logger.formatters.dev;\nlogger.setLevel('INFO'); //Initial log-level, overwritten by config later\n\n\nvar client = lwm2mlib.client;\nvar globalDeviceInfo = null;\nvar tempSensor = null;\nvar hue = null;\n\nlogger.debug(\"Initialising from config\");\ninit()\n    .catch(function (error) {\n        logger.fatal(\"Error while initialising! Abort.\");\n        if (error) {\n            logger.fatal(error);\n        }\n        process.exit(1);\n    })\n    .then(function () {\n        logger.info(\"Connecting to lwm2m-server [\" + config.connection.host + \":\" + config.connection.port + \"] as '\" + config.connection.endpoint + \"'\");\n        register() //TODO: add timeout\n            .catch(function (error) {\n                logger.error(\"Could not connect to server!\", error);\n            })\n            .then(function () {\n                logger.info(\"Registered at server '\" + config.connection.host + \":\" + config.connection.port + \"' as '\"\n                    + config.connection.endpoint + \"'!\");\n            });\n    });\n\nfunction init() {\n    return new Promise(function (resolve, reject) {\n        if (!config || !config.hasOwnProperty(\"client\") || !config.hasOwnProperty(\"connection\")) {\n            reject(new Error(\"Invalid configuration! Can't start.\"));\n        }\n        else {\n            logger.setLevel(config.client.logLevel);\n\n            logger.info(\"Initialising client\");\n            //Init lwm2m-client\n            client.init(config);\n\n            logger.info(\"Starting devices\");\n            //Init devices attached and enabled\n            var devices = [];\n            if (config.sensors.hasOwnProperty(\"temperature\") && config.sensors.temperature.enabled === true) {\n                devices.push(initTempSensor());\n            }\n            else {\n                logger.debug(\"Device 'temperature' is disabled\");\n            }\n            if (config.sensors.hasOwnProperty(\"hue\") && config.sensors.hue.enabled === true) {\n                devices.push(initHue());\n            }\n            else {\n                logger.debug(\"Device 'hue' is disabled\");\n            }\n            Promise.all(devices) //Wait for devices before registering to server\n                .catch((errors) => {\n                    logger.error(\"Error while initialising devices!\", errors);\n                })\n                .then(resolve);\n        }\n    });\n}\n\nfunction initHue() {\n    return new Promise((resolve) => {\n        hue = new Hue(lwm2mlib.client, config.sensors.hue.hostname, config.sensors.hue.username);\n\n        hue.start()\n            .catch((error) => {\n                logger.error(\"Error while initialising philips-hue!\", error);\n            })\n            .then((lights) => {\n                logger.info(\"Hue: Connected lights\", Object.keys(lights));\n                resolve();\n            });\n    })\n}\n\nfunction initTempSensor() {\n    return new Promise((resolve) => {\n        tempSensor = new TempSensor(lwm2mlib.client, config.sensors.temperature.refreshInterval);\n        tempSensor.start()\n            .catch((error) => {\n                logger.error(\"Temperature: Error while starting temperature-sensor!\", error);\n                resolve();\n            })\n            .then(() => {\n                logger.info(\"Temperature: Found temperature sensor/s\", tempSensor.sensors);\n                resolve();\n            });\n    });\n}\n\n\nfunction execute(objectType, objectId, resourceId, value, callback) {\n    logger.debug(\"Received 'execute'\\n\" + objectType + \"/\" + objectId + \" \" + resourceId + \" \" + value);\n    callback(null);\n}\n\nfunction read(objectType, objectId, resourceId, value, callback) {\n    logger.debug(\"Received 'read'\\n\" + objectType + \"/\" + objectId + \" \" + resourceId + \" \" + value);\n    callback(null);\n}\n\nfunction write(objectType, objectId, resourceId, value, callback) {\n    logger.debug(\"Received 'write'\\n\" + objectType + \"/\" + objectId + \" \" + resourceId + \" \" + value);\n\n    if (config.sensors.hue.enabled === true && hue !== null) {\n        if (objectType == \"3311\") {\n            hue.handleWrite(objectType, objectId, resourceId, value)\n                .catch((error) => {\n                    logger.error(\"Hue: Error while handling lwm2m-write\", error);\n                    callback(error); //TODO: Set error code, not error-msg\n                })\n                .then(() => {\n                    callback(null); //No error\n                });\n        }\n    }\n    else {\n        callback(null);\n    }\n\n\n}\n\nfunction setHandlers(deviceInfo) {\n    client.setHandler(deviceInfo.serverInfo, 'write', write);\n    client.setHandler(deviceInfo.serverInfo, 'execute', execute);\n    client.setHandler(deviceInfo.serverInfo, 'read', read);\n}\n\nfunction register() {\n    return new Promise(function (resolve, reject) {\n        if (globalDeviceInfo) {\n            reject(new Error(\"Can not register, already registered!\"));\n        }\n        else {\n            client.register(config.connection.host, config.connection.port, config.connection.url,\n                config.connection.endpoint, function (error, deviceInfo) {\n                    if (error) {\n                        reject(error);\n                    }\n                    else {\n                        globalDeviceInfo = deviceInfo;\n                        setHandlers(deviceInfo);\n\n                        logger.debug(\"Registration-info\", deviceInfo);\n                        resolve();\n                    }\n                })\n        }\n    });\n}\n\nfunction unregister() {\n    return new Promise(function (resolve, reject) {\n        if (!globalDeviceInfo) {\n            reject(new Error(\"Can't unregister, not registered!\"));\n        }\n        else {\n            client.unregister(globalDeviceInfo, function (error) {\n                if (error) {\n                    reject(error);\n                }\n                else {\n                    globalDeviceInfo = null;\n                    resolve();\n                }\n            })\n        }\n    });\n}\n\nfunction cmd_showConfig() {\n    logger.info(\"Loaded configuration\", config);\n}\n\nfunction cmd_stop() {//TODO: Make sure lwm2m is unregistered before stopping devices\n    logger.info(\"Stopping client\");\n    const timeout_ms = 3000;\n\n    var timeout = setTimeout(() => {\n        logger.info(\"Timeout: Unable to unregister from server within \" + timeout_ms + \"ms!\");\n        stopDevices();\n        cmd_exit();\n    }, timeout_ms);\n\n    unregister()\n        .catch(function (error) {\n            logger.error(\"Error while unregistering from server!\");\n            if (error) {\n                logger.error(error);\n            }\n            clearTimeout(timeout);\n            stopDevices();\n            cmd_exit();\n        })\n        .then(function () {\n            clearTimeout(timeout);\n            logger.info(\"Unregistered from '\" + config.connection.host + \":\" + config.connection.port + \"'!\");\n            logger.info(\"Stopping devices\");\n            stopDevices();\n\n            cmd_exit();\n        });\n}\n\nfunction stopDevices() {\n    if (tempSensor) {\n        logger.info(\"Stopping temperature-sensor\");\n        tempSensor.stop();\n    }\n    if (hue) {\n        logger.info(\"Stopping hue\");\n        hue.stop();\n    }\n}\n\nfunction cmd_exit() {\n    logger.info(\"Stopping cmd...\");\n    process.exit(0);\n}\n\nvar commands = {\n    'stop': {\n        parameters: [],\n        description: '\\tStop client',\n        handler: cmd_stop\n    },\n    'exit': {\n        parameters: [],\n        description: '\\tExit cmd, forces running threads to stop.',\n        handler: cmd_exit\n    },\n    'config': {\n        parameters: [],\n        description: '\\tShow current configuration',\n        handler: cmd_showConfig\n    }\n};\n\ncmd.initialize(commands, '> ');\n"
  ]
}