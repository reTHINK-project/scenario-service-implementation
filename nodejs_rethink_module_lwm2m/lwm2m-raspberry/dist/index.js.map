{"version":3,"sources":["../src/index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["/*\n * Copyright [2015-2017] Fraunhofer Gesellschaft e.V., Institute for\n * Open Communication Systems (FOKUS)\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n *\n */\n'use strict';\n\n\nimport lwm2mlib from \"lwm2m-node-lib\";\nimport logger from \"logops\";\nimport cmd from \"command-node\";\nimport config from \"./../config\";\nimport TempSensor from \"./TempSensor\";\nimport Hue from \"./Hue\";\n\nlogger.format = logger.formatters.dev;\nlogger.setLevel('INFO'); //Initial log-level, overwritten by config later\n\n\nvar client = lwm2mlib.client;\nvar globalDeviceInfo = null;\nvar tempSensor = null;\nvar hue = null;\n\nlogger.debug(\"Initialising from config\");\ninit()\n    .catch(function (error) {\n        logger.fatal(\"Error while initialising! Abort.\");\n        if (error) {\n            logger.fatal(error);\n        }\n        process.exit(1);\n    })\n    .then(function () {\n        logger.info(\"Connecting to lwm2m-server [\" + config.connection.host + \":\" + config.connection.port + \"] as '\" + config.connection.endpoint + \"'\");\n        register() //TODO: add timeout\n            .catch(function (error) {\n                logger.error(\"Could not connect to server!\", error);\n            })\n            .then(function () {\n                logger.info(\"Registered at server '\" + config.connection.host + \":\" + config.connection.port + \"' as '\"\n                    + config.connection.endpoint + \"'!\");\n            });\n    });\n\nfunction init() {\n    return new Promise(function (resolve, reject) {\n        if (!config || !config.hasOwnProperty(\"client\") || !config.hasOwnProperty(\"connection\")) {\n            reject(new Error(\"Invalid configuration! Can't start.\"));\n        }\n        else {\n            logger.setLevel(config.client.logLevel);\n\n            logger.info(\"Initialising client\");\n            //Init lwm2m-client\n            client.init(config);\n\n            logger.info(\"Starting devices\");\n            //Init devices attached and enabled\n            var devices = [];\n            if (config.sensors.hasOwnProperty(\"temperature\") && config.sensors.temperature.enabled === true) {\n                devices.push(initTempSensor());\n            }\n            else {\n                logger.debug(\"Device 'temperature' is disabled\");\n            }\n            if (config.sensors.hasOwnProperty(\"hue\") && config.sensors.hue.enabled === true) {\n                devices.push(initHue());\n            }\n            else {\n                logger.debug(\"Device 'hue' is disabled\");\n            }\n            Promise.all(devices) //Wait for devices before registering to server\n                .catch((errors) => {\n                    logger.error(\"Error while initialising devices!\", errors);\n                })\n                .then(resolve);\n        }\n    });\n}\n\nfunction initHue() {\n    return new Promise((resolve) => {\n        hue = new Hue(lwm2mlib.client, config.sensors.hue.hostname, config.sensors.hue.username);\n\n        hue.start()\n            .catch((error) => {\n                logger.error(\"Error while initialising philips-hue!\", error);\n            })\n            .then((lights) => {\n                logger.info(\"Hue: Connected lights\", Object.keys(lights));\n                resolve();\n            });\n    })\n}\n\nfunction initTempSensor() {\n    return new Promise((resolve) => {\n        tempSensor = new TempSensor(lwm2mlib.client, config.sensors.temperature.refreshInterval);\n        tempSensor.start()\n            .catch((error) => {\n                logger.error(\"Temperature: Error while starting temperature-sensor!\", error);\n                resolve();\n            })\n            .then(() => {\n                logger.info(\"Temperature: Found temperature sensor/s\", tempSensor.sensors);\n                resolve();\n            });\n    });\n}\n\n\nfunction execute(objectType, objectId, resourceId, value, callback) {\n    logger.debug(\"Received 'execute'\\n\" + objectType + \"/\" + objectId + \" \" + resourceId + \" \" + value);\n    callback(null);\n}\n\nfunction read(objectType, objectId, resourceId, value, callback) {\n    logger.debug(\"Received 'read'\\n\" + objectType + \"/\" + objectId + \" \" + resourceId + \" \" + value);\n    callback(null);\n}\n\nfunction write(objectType, objectId, resourceId, value, callback) {\n    logger.debug(\"Received 'write'\\n\" + objectType + \"/\" + objectId + \" \" + resourceId + \" \" + value);\n\n    if (config.sensors.hue.enabled === true && hue !== null) {\n        if (objectType == \"3311\") {\n            hue.handleWrite(objectType, objectId, resourceId, value)\n                .catch((error) => {\n                    logger.error(\"Hue: Error while handling lwm2m-write\", error);\n                    callback(error); //TODO: Set error code, not error-msg\n                })\n                .then(() => {\n                    callback(null); //No error\n                });\n        }\n    }\n    else {\n        callback(null);\n    }\n\n\n}\n\nfunction setHandlers(deviceInfo) {\n    client.setHandler(deviceInfo.serverInfo, 'write', write);\n    client.setHandler(deviceInfo.serverInfo, 'execute', execute);\n    client.setHandler(deviceInfo.serverInfo, 'read', read);\n}\n\nfunction register() {\n    return new Promise(function (resolve, reject) {\n        if (globalDeviceInfo) {\n            reject(new Error(\"Can not register, already registered!\"));\n        }\n        else {\n            client.register(config.connection.host, config.connection.port, config.connection.url,\n                config.connection.endpoint, function (error, deviceInfo) {\n                    if (error) {\n                        reject(error);\n                    }\n                    else {\n                        globalDeviceInfo = deviceInfo;\n                        setHandlers(deviceInfo);\n\n                        logger.debug(\"Registration-info\", deviceInfo);\n                        resolve();\n                    }\n                })\n        }\n    });\n}\n\nfunction unregister() {\n    return new Promise(function (resolve, reject) {\n        if (!globalDeviceInfo) {\n            reject(new Error(\"Can't unregister, not registered!\"));\n        }\n        else {\n            client.unregister(globalDeviceInfo, function (error) {\n                if (error) {\n                    reject(error);\n                }\n                else {\n                    globalDeviceInfo = null;\n                    resolve();\n                }\n            })\n        }\n    });\n}\n\nfunction cmd_showConfig() {\n    logger.info(\"Loaded configuration\", config);\n}\n\nfunction cmd_stop() {//TODO: Make sure lwm2m is unregistered before stopping devices\n    logger.info(\"Stopping client\");\n\n    unregister()\n        .catch(function (error) {\n            logger.error(\"Error while unregistering from server!\");\n            if (error) {\n                logger.error(error);\n            }\n            cmd_exit();\n        })\n        .then(function () {\n            logger.info(\"Unregistered from '\" + config.connection.host + \":\" + config.connection.port + \"'!\");\n            cmd_exit();\n        });\n\n    logger.info(\"Stopping devices\");\n    if (tempSensor) {\n        logger.info(\"Stopping temperature-sensor\");\n        tempSensor.stop();\n    }\n    if (hue) {\n        logger.info(\"Stopping hue\");\n        hue.stop();\n    }\n}\n\nfunction cmd_exit() {\n    logger.info(\"Stopping cmd...\");\n    process.exit(0);\n}\n\nvar commands = {\n    'stop': {\n        parameters: [],\n        description: '\\tStop client',\n        handler: cmd_stop\n    },\n    'exit': {\n        parameters: [],\n        description: '\\tExit cmd, forces running threads to stop.',\n        handler: cmd_exit\n    },\n    'config': {\n        parameters: [],\n        description: '\\tShow current configuration',\n        handler: cmd_showConfig\n    }\n};\n\ncmd.initialize(commands, '> ');\n"]}